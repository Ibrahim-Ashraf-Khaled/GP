# ğŸ¤– Cursor AI Agent - Prompts Ù„Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© Prompts Ù…ØªØ¯Ø±Ø¬Ø© Ù„Ù€ Cursor AI Agent Ù„ØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø±ÙˆØ¹ Gamasa Properties.
Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù€ Prompts **Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨** ÙˆØ§Ù†ØªØ¸Ø± Ø¥ØªÙ…Ø§Ù… ÙƒÙ„ prompt Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ§Ù„ÙŠ.

**Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:** 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ (80 Ø³Ø§Ø¹Ø©)
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** P0 (Blocker) â†’ P1 (High) â†’ P2 (Medium) â†’ P3 (Low)

---

## ğŸ¯ Prompt #0: Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Context Loading)

```
Ø£Ù†Øª Cursor AI Agent Ù…ØªØ®ØµØµ ÙÙŠ Next.js 16ØŒ React 19ØŒ TypeScriptØŒ Ùˆ Supabase.

Ù…Ù‡Ù…ØªÙƒ: Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø±ÙˆØ¹ Gamasa Properties (Ù…Ù†ØµØ© Ø¹Ù‚Ø§Ø±ÙŠØ©) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ ØªÙ‚Ù†ÙŠ Ø´Ø§Ù…Ù„.

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:
- Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª: Next.js 16 (App Router), React 19, TypeScript, Tailwind CSS, Supabase
- Ø§Ù„Ù…ÙŠØ²Ø§Øª: Ù…ØµØ§Ø¯Ù‚Ø©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ø­Ø¬ÙˆØ²Ø§ØªØŒ Ø®Ø±Ø§Ø¦Ø· LeafletØŒ Ø±Ø³Ø§Ø¦Ù„
- Ø§Ù„Ø­Ø§Ù„Ø©: Mock Mode Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø¨Ù‡ 10 Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø©

# Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:
1. gamasa_technical_analysis.md - Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
2. gamasa_tasks_actionable.md - Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°
3. gamasa_unified_analysis.md - Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯
4. gamasa_daily_execution_plan.md - Ø§Ù„Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
5. gamasa_comparison_analysis.md - Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙˆØ§Ù„Ù‚Ø±Ø§Ø±Ø§Øª
6. gamasa_ai_agent_prompts.md - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù€ Prompts

# Ø®Ø·ÙˆØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰:
1. Ø§Ù‚Ø±Ø£ Ù…Ù„Ù `gamasa_unified_analysis.md` Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
2. Ø§ÙÙ‡Ù… Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© Ø§Ù„Ø¹Ø´Ø±Ø©
3. Ø±Ø§Ø¬Ø¹ Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (4 Ø£Ø³Ø§Ø¨ÙŠØ¹)
4. Ø£ÙƒÙ‘Ø¯ ÙÙ‡Ù…Ùƒ Ø¨Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ±

Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†ØªÙ‡ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ£Ù†Øª Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡.
```

**Ø§Ù†ØªØ¸Ø± Ø±Ø¯ Cursor Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù€ Prompt Ø§Ù„ØªØ§Ù„ÙŠ**

---

## ğŸ”´ Prompt #1: Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ - Day 1 Setup

```
Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø³Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„: Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø­Ø±Ø¬Ø©.

# Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ - Ø§Ù„Ù…Ù‡Ø§Ù…:

## Task 1.1: Git Setup
Ø£Ù†Ø´Ø¦ branch Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù…Ù„:

```bash
git checkout -b week1-critical-fixes
```

## Task 1.2: Fix IS_MOCK_MODE (P0 - Blocker)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** `IS_MOCK_MODE = true` Ù…ÙØ«Ø¨Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- src/services/supabaseService.ts (Line 6)
- src/context/AuthContext.tsx (Line 9)

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
1. ÙÙŠ `src/services/supabaseService.ts` Line 6ØŒ ØºÙŠÙ‘Ø±:
```typescript
// Ù…Ù†:
export const IS_MOCK_MODE = true;

// Ø¥Ù„Ù‰:
export const IS_MOCK_MODE = 
  typeof window !== 'undefined'
    ? window.localStorage.getItem('DEV_MOCK_MODE') === 'true'
    : process.env.NEXT_PUBLIC_IS_MOCK_MODE === 'true';
```

2. ÙÙŠ `src/context/AuthContext.tsx` Line 9ØŒ ØºÙŠÙ‘Ø±:
```typescript
// Ù…Ù†:
const IS_MOCK_MODE = process.env.NEXT_PUBLIC_IS_MOCK_MODE === 'true' || true;

// Ø¥Ù„Ù‰:
const IS_MOCK_MODE = process.env.NEXT_PUBLIC_IS_MOCK_MODE === 'true';
```

3. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ `.env.local`:
```env
NEXT_PUBLIC_IS_MOCK_MODE=true
NEXT_PUBLIC_SUPABASE_URL=your-dev-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-dev-key
```

**Ø§Ù„ØªØ­Ù‚Ù‚:**
- [ ] Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙŠ mock mode (NEXT_PUBLIC_IS_MOCK_MODE=true)
- [ ] Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙŠ production mode (NEXT_PUBLIC_IS_MOCK_MODE=false)
- [ ] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ console

**Commit Message:**
```
fix: Remove hardcoded IS_MOCK_MODE flag

- Changed IS_MOCK_MODE to read from environment
- Removed || true fallback in AuthContext
- Added proper .env files

Fixes #1 (Mock Mode Blocker)
```

Ù†ÙÙ‘Ø° Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ£Ø®Ø¨Ø±Ù†ÙŠ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©.
```

---

## ğŸ”´ Prompt #2: Fix SQL Injection (P0)

```
Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.

## Task 1.3: Fix SQL Injection (P0 - Critical Security)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø§Ø³ØªØ®Ø¯Ø§Ù… string interpolation ÙÙŠ SQL queries.

**Ø§Ù„Ù…Ù„Ù:** `src/services/supabaseService.ts`

**Ø§Ø¨Ø­Ø« Ø¹Ù†:**
```typescript
.or(`start_date.lte.${endDate},end_date.gte.${startDate}`)
```

**Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ù€:**
```typescript
.gte('end_date', startDate)
.lte('start_date', endDate)
```

**Ø§Ù„Ø®Ø·ÙˆØ§Øª:**
1. Ø§ÙØªØ­ `src/services/supabaseService.ts`
2. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ù„Ø© `checkAvailability`
3. ØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ `.or()`
4. Ø§Ø­Ø°Ù Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± Ù„Ù€ template literals ÙÙŠ queries

**Ø§Ø®ØªØ¨Ø§Ø±:**
Ø¬Ø±Ù‘Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ malicious input:
```typescript
checkAvailability('prop-1', '2024-01-01', "2024-01-01' OR '1'='1")
```
ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØ³Ø¨Ø¨ Ø®Ø·Ø£ SQL.

**Commit:**
```
fix: Prevent SQL injection in availability check

- Replaced .or() string interpolation with .gte()/.lte()
- Removed all template literals from SQL queries

Fixes #5 (SQL Injection)
```

Ù†ÙÙ‘Ø° Ø«Ù… Ø£Ø®Ø¨Ø±Ù†ÙŠ.
```

---

## ğŸ”´ Prompt #3: Fix Schema/Types Mismatch (P1)

```
Ø¹Ø¸ÙŠÙ…! Ø§Ù„ØªØ§Ù„ÙŠ.

## Task 1.4: Schema/Types Alignment (P1 - High)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Schema ÙŠØ³ØªØ®Ø¯Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØŒ Types ØªØ³ØªØ®Ø¯Ù… Ø¹Ø±Ø¨ÙŠ.

**Ù…Ø«Ø§Ù„:**
- Schema: `booking_type IN ('day', 'week', ...)`
- Types: `booking_type: 'ÙŠÙˆÙ…' | 'Ø£Ø³Ø¨ÙˆØ¹' | ...`

**Ø§Ù„Ø­Ù„:** ØªÙˆØ­ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†.

### Step 1: Ø¥Ù†Ø´Ø§Ø¡ Migration

Ø£Ù†Ø´Ø¦ Ù…Ù„Ù: `supabase/migrations/20260208_fix_enum_values.sql`

```sql
-- Fix booking_type
ALTER TABLE bookings 
DROP CONSTRAINT IF EXISTS bookings_booking_type_check;

ALTER TABLE bookings 
ADD CONSTRAINT bookings_booking_type_check 
CHECK (booking_type IN ('daily', 'weekly', 'monthly', 'seasonal'));

-- Fix property category
ALTER TABLE properties
DROP CONSTRAINT IF EXISTS properties_category_check;

ALTER TABLE properties
ADD CONSTRAINT properties_category_check
CHECK (category IN ('apartment', 'villa', 'chalet', 'studio', 'office', 'land'));

-- Fix property status
ALTER TABLE properties
DROP CONSTRAINT IF EXISTS properties_status_check;

ALTER TABLE properties
ADD CONSTRAINT properties_status_check
CHECK (status IN ('available', 'unavailable', 'pending', 'rented'));
```

### Step 2: ØªØ­Ø¯ÙŠØ« Types

ÙÙŠ `src/types/database.types.ts`:

```typescript
export type BookingType = 'daily' | 'weekly' | 'monthly' | 'seasonal';
export type PropertyCategory = 'apartment' | 'villa' | 'chalet' | 'studio' | 'office' | 'land';
export type PropertyStatus = 'available' | 'unavailable' | 'pending' | 'rented';

// Add translation maps for UI
export const BOOKING_TYPE_AR: Record<BookingType, string> = {
  daily: 'ÙŠÙˆÙ…ÙŠ',
  weekly: 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
  monthly: 'Ø´Ù‡Ø±ÙŠ',
  seasonal: 'Ù…ÙˆØ³Ù…ÙŠ'
};

export const CATEGORY_AR: Record<PropertyCategory, string> = {
  apartment: 'Ø´Ù‚Ø©',
  villa: 'ÙÙŠÙ„Ø§',
  chalet: 'Ø´Ø§Ù„ÙŠÙ‡',
  studio: 'Ø§Ø³ØªÙˆØ¯ÙŠÙˆ',
  office: 'Ù…ÙƒØªØ¨',
  land: 'Ø£Ø±Ø¶'
};
```

### Step 3: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª

Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ù…ÙƒØ§Ù† ÙŠØ¹Ø±Ø¶ `property.category` Ø£Ùˆ `booking.type` ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©:

```typescript
// Ù…Ø«Ø§Ù„ ÙÙŠ PropertyCard.tsx
import { CATEGORY_AR } from '@/types/database.types';

<span>{CATEGORY_AR[property.category]}</span>
```

**Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« 10-15 Ù…Ù„Ù.

**Commit:**
```
fix: Align database schema with TypeScript types

Schema changes:
- booking_type: Arabic â†’ English values
- category: Arabic â†’ English values
- status: Arabic â†’ English values

Code changes:
- Updated database.types.ts
- Added translation maps (CATEGORY_AR, etc)
- Updated all components to use translations

Fixes #7 (Schema/Types Mismatch)
```

Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ÙƒÙ„ Ø®Ø·ÙˆØ©.
```

---

## ğŸ”´ Prompt #4: Race Condition Fix - Part 1 (Database)

```
Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ù†ØµÙ„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ÙƒØ¨Ø±: Race Condition.

## Task 1.5: Race Condition Fix - Database Function (P0)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** checkAvailability Ùˆ createBooking Ø¹Ù…Ù„ÙŠØªØ§Ù† Ù…Ù†ÙØµÙ„ØªØ§Ù†.
**Ø§Ù„Ù†ØªÙŠØ¬Ø©:** Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø­Ø¬Ø² Ù…Ø²Ø¯ÙˆØ¬.

**Ø§Ù„Ø­Ù„:** Ø¥Ù†Ø´Ø§Ø¡ database function Ø°Ø±ÙŠØ© (atomic).

### Step 1: Ø¥Ù†Ø´Ø§Ø¡ Function

Ø£Ù†Ø´Ø¦ Ù…Ù„Ù: `supabase/migrations/20260208_atomic_booking.sql`

```sql
CREATE OR REPLACE FUNCTION create_booking_atomically(
  p_property_id UUID,
  p_guest_id UUID,
  p_start_date DATE,
  p_end_date DATE,
  p_rental_type TEXT,
  p_total_amount DECIMAL,
  p_booking_type TEXT
) RETURNS TABLE(
  booking_id UUID, 
  success BOOLEAN, 
  error_message TEXT
) AS $$
DECLARE
  v_booking_id UUID;
  v_conflict_count INT;
BEGIN
  -- Lock the property's booking rows
  PERFORM id FROM bookings
  WHERE property_id = p_property_id
    AND status IN ('confirmed', 'pending')
  FOR UPDATE;
  
  -- Check for overlapping bookings
  SELECT COUNT(*) INTO v_conflict_count
  FROM bookings
  WHERE property_id = p_property_id
    AND status IN ('confirmed', 'pending')
    AND (
      (p_start_date >= start_date AND p_start_date < end_date)
      OR
      (p_end_date > start_date AND p_end_date <= end_date)
      OR
      (p_start_date <= start_date AND p_end_date >= end_date)
    );
  
  IF v_conflict_count > 0 THEN
    RETURN QUERY SELECT 
      NULL::UUID, 
      FALSE, 
      'Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©'::TEXT;
    RETURN;
  END IF;
  
  -- Validate dates
  IF p_end_date <= p_start_date THEN
    RETURN QUERY SELECT 
      NULL::UUID, 
      FALSE, 
      'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'::TEXT;
    RETURN;
  END IF;
  
  -- Check property available
  IF NOT EXISTS (
    SELECT 1 FROM properties 
    WHERE id = p_property_id 
      AND status = 'available'
  ) THEN
    RETURN QUERY SELECT 
      NULL::UUID, 
      FALSE, 
      'Ø§Ù„Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø­Ø¬Ø²'::TEXT;
    RETURN;
  END IF;
  
  -- Create booking
  INSERT INTO bookings (
    property_id,
    guest_id,
    start_date,
    end_date,
    rental_type,
    total_amount,
    booking_type,
    status
  ) VALUES (
    p_property_id,
    p_guest_id,
    p_start_date,
    p_end_date,
    p_rental_type,
    p_total_amount,
    p_booking_type,
    'pending'
  ) RETURNING id INTO v_booking_id;
  
  RETURN QUERY SELECT 
    v_booking_id, 
    TRUE, 
    NULL::TEXT;
END;
$$ LANGUAGE plpgsql;

-- Add index for performance
CREATE INDEX IF NOT EXISTS idx_bookings_property_date_status
ON bookings (property_id, start_date, end_date, status)
WHERE status IN ('confirmed', 'pending');
```

### Step 2: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ù€ migration ÙÙŠ Supabase:
1. Ø§Ø°Ù‡Ø¨ Ù„Ù€ Supabase Dashboard
2. SQL Editor
3. Ø§Ù†Ø³Ø® Ø§Ù„Ù€ SQL Ø£Ø¹Ù„Ø§Ù‡
4. Run
5. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡

**Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… CLI:**
```bash
supabase db push
```

**Commit:**
```
feat: Add atomic booking database function

- Created create_booking_atomically function
- Added proper overlap detection
- Added date validation
- Added property status check
- Added performance index

Part 1 of fixing #3 (Race Condition)
```

Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.
```

---

## ğŸ”´ Prompt #5: Race Condition Fix - Part 2 (TypeScript)

```
Ø±Ø§Ø¦Ø¹! Ø§Ù„Ø¢Ù† Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù€ Function.

## Task 1.6: Race Condition Fix - TypeScript Integration (P0)

### Step 1: Ø­Ø°Ù checkAvailability

ÙÙŠ `src/services/supabaseService.ts`:
- Ø§Ø­Ø°Ù Ø¯Ø§Ù„Ø© `checkAvailability` Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù… ØªØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ©)

### Step 2: ØªØ­Ø¯ÙŠØ« createBooking

Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© `createBooking` Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:

```typescript
interface CreateBookingParams {
  propertyId: string;
  guestId: string;
  startDate: string;
  endDate: string;
  rentalType: 'daily' | 'weekly' | 'monthly' | 'seasonal';
  totalAmount: number;
  bookingType: 'online' | 'offline';
}

interface BookingResult {
  data: { id: string } | null;
  error: { message: string } | null;
}

async createBooking(params: CreateBookingParams): Promise<BookingResult> {
  if (IS_MOCK_MODE) {
    const mockBooking = {
      id: `BK-${Date.now()}`,
      ...params,
      status: 'pending',
      created_at: new Date().toISOString()
    };
    
    await new Promise(resolve => setTimeout(resolve, 500));
    
    return {
      data: { id: mockBooking.id },
      error: null
    };
  }

  try {
    const { data, error } = await supabase.rpc('create_booking_atomically', {
      p_property_id: params.propertyId,
      p_guest_id: params.guestId,
      p_start_date: params.startDate,
      p_end_date: params.endDate,
      p_rental_type: params.rentalType,
      p_total_amount: params.totalAmount,
      p_booking_type: params.bookingType
    });

    if (error) {
      return {
        data: null,
        error: { message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²' }
      };
    }

    const result = data?.[0];
    
    if (!result?.success) {
      return {
        data: null,
        error: { message: result?.error_message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø²' }
      };
    }

    return {
      data: { id: result.booking_id },
      error: null
    };
  } catch (error: any) {
    return {
      data: null,
      error: { message: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹' }
    };
  }
}
```

### Step 3: ØªØ­Ø¯ÙŠØ« Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ø¯Ø§Ù„Ø©

Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† ÙŠØ³ØªØ®Ø¯Ù… `checkAvailability`:
```bash
grep -r "checkAvailability" src/
```

Ø§Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù„Ø£Ù†Ù‡Ø§ Ø£ØµØ¨Ø­Øª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† `createBooking`.

### Step 4: ØªØ­Ø¯ÙŠØ« BookingPage

ÙÙŠ `src/app/property/[id]/booking/page.tsx`:

```typescript
const handleBooking = async () => {
  if (!user) {
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  setLoading(true);
  setError('');

  try {
    const { data, error } = await supabaseService.createBooking({
      propertyId: params.id,
      guestId: user.id,
      startDate: startDate.toISOString().split('T')[0],
      endDate: endDate.toISOString().split('T')[0],
      rentalType: bookingType,
      totalAmount: priceBreakdown.totalPrice,
      bookingType: 'online'
    });

    if (error) {
      setError(error.message);
      return;
    }

    setSuccess(true);
    setTimeout(() => router.push('/my-bookings'), 2000);
    
  } catch (err: any) {
    setError(err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²');
  } finally {
    setLoading(false);
  }
};
```

**Commit:**
```
fix: Implement atomic booking to prevent race conditions

- Removed checkAvailability (now part of atomic function)
- Updated createBooking to use RPC
- Updated BookingPage to handle new flow
- Added comprehensive error handling

Fixes #3 (Race Condition in Bookings)
```

Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.
```

---

## ğŸ”´ Prompt #6: Fix unlockProperty Payment Bypass (P0)

```
Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ù…Ø´ÙƒÙ„Ø© Ø£Ù…Ù†ÙŠØ© Ø­Ø±Ø¬Ø© Ø£Ø®Ø±Ù‰.

## Task 1.7: Secure unlockProperty (P0 - Critical Security)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ø£ÙŠ Ø´Ø®Øµ ÙŠÙ…ÙƒÙ†Ù‡ ÙØªØ­ Ø£ÙŠ Ø¹Ù‚Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¯ÙØ¹.

### Step 1: Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ is_consumed

Ù…Ù„Ù: `supabase/migrations/20260208_payment_consumed.sql`

```sql
-- Add is_consumed column
ALTER TABLE payment_requests 
ADD COLUMN IF NOT EXISTS is_consumed BOOLEAN DEFAULT FALSE;

-- Add index
CREATE INDEX IF NOT EXISTS idx_payment_requests_active
ON payment_requests(property_id, user_id, status, is_consumed)
WHERE status = 'approved' AND is_consumed = FALSE;

-- Prevent duplicate unconsumed payments
CREATE UNIQUE INDEX IF NOT EXISTS idx_payment_requests_unique_active
ON payment_requests(property_id, user_id)
WHERE status = 'approved' AND is_consumed = FALSE;
```

### Step 2: Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Unlock Atomic

Ù…Ù„Ù: `supabase/migrations/20260208_atomic_unlock.sql`

```sql
CREATE OR REPLACE FUNCTION unlock_property_with_payment(
  p_user_id UUID,
  p_property_id UUID,
  p_payment_id UUID
) RETURNS VOID AS $$
DECLARE
  v_payment_amount DECIMAL;
  v_min_amount DECIMAL := 50.00;
BEGIN
  -- Mark payment as consumed
  UPDATE payment_requests
  SET is_consumed = TRUE
  WHERE id = p_payment_id
    AND user_id = p_user_id
    AND property_id = p_property_id
    AND status = 'approved'
    AND is_consumed = FALSE
  RETURNING amount INTO v_payment_amount;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹ Ù…Ø¹ØªÙ…Ø¯ Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„';
  END IF;
  
  -- Validate amount
  IF v_payment_amount < v_min_amount THEN
    UPDATE payment_requests SET is_consumed = FALSE WHERE id = p_payment_id;
    RAISE EXCEPTION 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (% Ø¬Ù†ÙŠÙ‡) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ (% Ø¬Ù†ÙŠÙ‡)',
      v_payment_amount, v_min_amount;
  END IF;
  
  -- Insert unlock
  INSERT INTO unlocked_properties (user_id, property_id, unlocked_at)
  VALUES (p_user_id, p_property_id, NOW())
  ON CONFLICT (user_id, property_id) DO NOTHING;
  
EXCEPTION
  WHEN OTHERS THEN
    RAISE;
END;
$$ LANGUAGE plpgsql;
```

### Step 3: ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯

ÙÙŠ `src/services/supabaseService.ts`:

```typescript
async unlockProperty(
  userId: string, 
  propertyId: string
): Promise<void> {
  if (IS_MOCK_MODE) {
    _mockUnlocked.add(propertyId);
    return;
  }

  try {
    // Find approved unconsumed payment
    const { data: payment, error: paymentError } = await supabase
      .from('payment_requests')
      .select('*')
      .eq('user_id', userId)
      .eq('property_id', propertyId)
      .eq('status', 'approved')
      .eq('is_consumed', false)
      .maybeSingle();

    if (paymentError) {
      throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹: ${paymentError.message}`);
    }

    if (!payment) {
      throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹ Ù…Ø¹ØªÙ…Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±. ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50 Ø¬Ù†ÙŠÙ‡ Ø£ÙˆÙ„Ø§Ù‹');
    }

    // Check if already unlocked
    const { data: alreadyUnlocked } = await supabase
      .from('unlocked_properties')
      .select('id')
      .eq('user_id', userId)
      .eq('property_id', propertyId)
      .maybeSingle();

    if (alreadyUnlocked) {
      throw new Error('Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„');
    }

    // Atomic unlock
    const { error: unlockError } = await supabase.rpc(
      'unlock_property_with_payment',
      {
        p_user_id: userId,
        p_property_id: propertyId,
        p_payment_id: payment.id
      }
    );

    if (unlockError) {
      throw new Error(unlockError.message);
    }
  } catch (error: any) {
    throw error;
  }
}
```

**Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ù€ Migrations ÙÙŠ Supabase.**

**Commit:**
```
fix: Secure unlockProperty with payment verification

Database:
- Added is_consumed column to payment_requests
- Created unlock_property_with_payment function
- Added indexes and constraints

Code:
- Updated unlockProperty to verify payment
- Added amount validation (min 50 EGP)
- Prevent payment reuse
- Atomic operation

Fixes #4 (Payment Bypass)
```

Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.
```

---

## ğŸŸ¡ Prompt #7: End of Day 1 - Review & Testing

```
Ø¹Ø¸ÙŠÙ…! Ø£Ù†Ù‡ÙŠÙ†Ø§ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø±Ø¬Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„.

## Day 1 Review & Testing

### âœ… Ù…Ø§ ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡:
1. âœ… Fixed IS_MOCK_MODE (P0)
2. âœ… Fixed SQL Injection (P0)
3. âœ… Fixed Schema/Types mismatch (P1)
4. âœ… Fixed Race Condition (P0)
5. âœ… Fixed Payment Bypass (P0)

### ğŸ§ª Testing Required:

**Test 1: Mock Mode Toggle**
```bash
# Test with mock ON
NEXT_PUBLIC_IS_MOCK_MODE=true npm run dev
# Verify mock data appears

# Test with mock OFF
NEXT_PUBLIC_IS_MOCK_MODE=false npm run dev
# Verify real Supabase data
```

**Test 2: Booking Flow**
1. Open property details page
2. Click "Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†"
3. Select dates
4. Complete form
5. Submit booking
6. Verify: Should succeed or show clear error

**Test 3: Try Double Booking**
Open two browser tabs:
- Tab 1: Book property for March 1-5
- Tab 2: Book same property for March 1-5
- Result: Only ONE should succeed

**Test 4: Unlock Property**
1. Submit payment request (50 EGP)
2. Admin approves payment
3. Try unlock property
4. Should succeed
5. Try unlock again
6. Should fail with "Ø§Ù„Ø¹Ù‚Ø§Ø± Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„"

### ğŸ“ Final Commits:

```bash
# Create comprehensive commit
git add .
git commit -m "Day 1: Critical fixes completed

Fixed Issues:
- #1: IS_MOCK_MODE hardcoded (P0)
- #5: SQL Injection (P0)
- #7: Schema/Types mismatch (P1)
- #3: Race Condition in bookings (P0)
- #4: Payment bypass (P0)

Total: 5 critical issues resolved
Time: 8 hours
Status: Ready for Day 2

Tests:
- âœ… Mock mode toggle works
- âœ… Booking prevents double booking
- âœ… Payment verification works
- âœ… No SQL injection vulnerabilities"

# Push to remote
git push origin week1-critical-fixes
```

### ğŸ“Š Progress Report:

```
=== Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ - Ù…Ù„Ø®Øµ ===
âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: 5/5
â±ï¸  Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: 8 Ø³Ø§Ø¹Ø§Øª
ğŸ› Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙØµÙ„Ø­Ø©: 5 critical
ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: Manual testing
ğŸ“ Commits: 6

ğŸ“‹ Ù„ÙŠÙˆÙ… ØºØ¯Ø§Ù‹ (Day 2):
- [ ] Fix Client/Server component issues
- [ ] Add input validation
- [ ] Error boundaries
- [ ] Start auth consolidation
```

Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ£Ø®Ø¨Ø±Ù†ÙŠ Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬.
Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„ØŒ Ù†ÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ!
```

---

## ğŸ”µ Prompt #8: Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ - Day 2 Start

```
ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±! Ù†Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ.

## Day 2: Client/Server Components & Validation

### Morning Standup (9:00-9:15):
- [ ] Review yesterday's work
- [ ] Test all fixes still working
- [ ] Check for any issues

### Task 2.1: Fix Client/Server Component Issues (10:00-12:00)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** ØµÙØ­Ø§Øª ØªØ³ØªØ®Ø¯Ù… hooks Ø¨Ø¯ÙˆÙ† 'use client'.

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:**
- src/app/property/[id]/page.tsx
- src/app/property/[id]/booking/page.tsx
- src/app/page.tsx (optional)

**Pattern Ù„Ù„Ø¥ØµÙ„Ø§Ø­:**

#### Before (Server Component with Client Logic):
```typescript
// src/app/property/[id]/page.tsx
export default function PropertyPage({ params }) {
  const [selectedImage, setSelectedImage] = useState(0); // âŒ Hook in server component
  // ...
}
```

#### After (Split Server + Client):

**File 1: page.tsx (Server Component)**
```typescript
// src/app/property/[id]/page.tsx
import { supabaseService } from '@/services/supabaseService';
import { PropertyClient } from './client';
import { notFound } from 'next/navigation';

export default async function PropertyPage({ params }: { params: { id: string } }) {
  const property = await supabaseService.getPropertyById(params.id);
  
  if (!property) {
    notFound();
  }

  return <PropertyClient property={property} />;
}

export async function generateMetadata({ params }: { params: { id: string } }) {
  const property = await supabaseService.getPropertyById(params.id);
  
  if (!property) return {};

  return {
    title: property.title,
    description: property.description,
    openGraph: {
      images: property.images,
    }
  };
}
```

**File 2: client.tsx (Client Component)**
```typescript
// src/app/property/[id]/client.tsx
'use client';

import { useState } from 'react';
import type { Property } from '@/types';

interface Props {
  property: Property;
}

export function PropertyClient({ property }: Props) {
  const [selectedImage, setSelectedImage] = useState(0); // âœ… Now allowed
  
  return (
    <div>
      {/* All interactive UI here */}
    </div>
  );
}
```

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
1. Ø·Ø¨Ù‘Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø· Ø¹Ù„Ù‰:
   - property/[id]/page.tsx
   - property/[id]/booking/page.tsx
2. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ build
3. Ø§Ø®ØªØ¨Ø± Ø£Ù† Ø§Ù„ØµÙØ­Ø§Øª ØªØ¹Ù…Ù„

**Commit:**
```
fix: Separate client and server components

- Split PropertyPage into page.tsx (server) + client.tsx
- Split BookingPage into page.tsx (server) + client.tsx
- Added generateMetadata for SEO
- Fixed hydration errors

Fixes #6 (Client/Server Component Issues)
```

Ø§Ø¨Ø¯Ø£ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.
```

---

## ğŸ”µ Prompt #9: Add Input Validation

```
## Task 2.2: Add Comprehensive Input Validation (1:00-3:00)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:** Ù„Ø§ ÙŠÙˆØ¬Ø¯ validation Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª.

### Step 1: Install Zod

```bash
npm install zod
```

### Step 2: Ø¥Ù†Ø´Ø§Ø¡ Validation Schemas

Ø£Ù†Ø´Ø¦ Ù…Ù„Ù: `src/lib/validation.ts`

```typescript
import { z } from 'zod';

// Email & Phone
export const emailSchema = z.string()
  .email('Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­');

export const phoneSchema = z.string()
  .regex(/^01[0-9]{9}$/, 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…ØµØ±ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01 Ùˆ 11 Ø±Ù‚Ù…)');

// Registration
export const registerSchema = z.object({
  email: emailSchema,
  password: z.string()
    .min(8, 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„')
    .regex(/[A-Za-z]/, 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„')
    .regex(/[0-9]/, 'ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'),
  fullName: z.string()
    .min(3, 'Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„')
    .max(50, 'Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹'),
  phone: phoneSchema,
  role: z.enum(['landlord', 'tenant', 'both'])
});

// Property
export const propertySchema = z.object({
  title: z.string()
    .min(10, 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ (10 Ø£Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)')
    .max(100, 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹'),
  description: z.string()
    .min(50, 'Ø§Ù„ÙˆØµÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹')
    .max(2000, 'Ø§Ù„ÙˆØµÙ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹'),
  price_per_day: z.number()
    .min(1, 'Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±')
    .max(1000000, 'Ø§Ù„Ø³Ø¹Ø± ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹'),
  bedrooms: z.number().min(0).max(20),
  bathrooms: z.number().min(0).max(10),
  area: z.number()
    .min(10, 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 10 Ù…ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„')
    .max(10000, 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹')
});

// Message
export const messageSchema = z.object({
  content: z.string()
    .min(1, 'Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©')
    .max(1000, 'Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ (1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)')
    .transform(sanitizeHtml)
});

// Payment
export const paymentSchema = z.object({
  amount: z.number()
    .min(50, 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯ÙØ¹ 50 Ø¬Ù†ÙŠÙ‡')
    .max(100000, 'Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹'),
  payment_method: z.enum(['vodafone_cash', 'instapay', 'fawry']),
  receipt_image: z.string()
    .url('Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥ÙŠØµØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­')
});

// Booking
export const bookingSchema = z.object({
  start_date: z.string().date('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­'),
  end_date: z.string().date('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ØºÙŠØ± ØµØ§Ù„Ø­'),
  rental_type: z.enum(['daily', 'weekly', 'monthly', 'seasonal']),
  total_amount: z.number().min(1)
}).refine(data => {
  const start = new Date(data.start_date);
  const end = new Date(data.end_date);
  return end > start;
}, {
  message: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
  path: ['end_date']
});

// HTML Sanitization
function sanitizeHtml(html: string): string {
  return html
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

// File Upload Validation
export const IMAGE_VALIDATION = {
  ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/webp'],
  MAX_SIZE: 5 * 1024 * 1024, // 5MB
  MIN_DIMENSION: 400,
  MAX_DIMENSION: 4000
};

export async function validateImageFile(file: File): Promise<{
  valid: boolean;
  error?: string;
}> {
  if (!IMAGE_VALIDATION.ALLOWED_TYPES.includes(file.type)) {
    return {
      valid: false,
      error: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… JPEGØŒ PNGØŒ Ø£Ùˆ WebP'
    };
  }

  if (file.size > IMAGE_VALIDATION.MAX_SIZE) {
    return {
      valid: false,
      error: 'Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)'
    };
  }

  try {
    const dimensions = await getImageDimensions(file);
    
    if (
      dimensions.width < IMAGE_VALIDATION.MIN_DIMENSION ||
      dimensions.height < IMAGE_VALIDATION.MIN_DIMENSION
    ) {
      return {
        valid: false,
        error: `Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø© (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${IMAGE_VALIDATION.MIN_DIMENSION}px)`
      };
    }
    
    if (
      dimensions.width > IMAGE_VALIDATION.MAX_DIMENSION ||
      dimensions.height > IMAGE_VALIDATION.MAX_DIMENSION
    ) {
      return {
        valid: false,
        error: `Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ${IMAGE_VALIDATION.MAX_DIMENSION}px)`
      };
    }
  } catch (error) {
    return {
      valid: false,
      error: 'ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©'
    };
  }

  return { valid: true };
}

function getImageDimensions(file: File): Promise<{ width: number; height: number }> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    
    img.onload = () => {
      URL.revokeObjectURL(url);
      resolve({ width: img.width, height: img.height });
    };
    
    img.onerror = () => {
      URL.revokeObjectURL(url);
      reject(new Error('Failed to load image'));
    };
    
    img.src = url;
  });
}
```

### Step 3: ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬

**Ù…Ø«Ø§Ù„: LoginForm**

```typescript
// src/components/auth/LoginForm.tsx
import { registerSchema } from '@/lib/validation';

const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // Validate
  try {
    const validData = registerSchema.parse({
      email: formData.email,
      password: formData.password,
      fullName: formData.fullName,
      phone: formData.phone,
      role: formData.role
    });
    
    // Proceed with valid data
    await register(validData);
  } catch (error) {
    if (error instanceof z.ZodError) {
      // Show validation errors
      const errors = error.errors.map(e => e.message).join('\n');
      setError(errors);
    }
  }
};
```

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
1. Ø·Ø¨Ù‘Ù‚ validation Ø¹Ù„Ù‰:
   - Login/Register forms
   - Property creation form
   - Booking form
   - Message form
   - Payment form
2. Ø£Ø¶Ù file upload validation
3. Ø§Ø®ØªØ¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬

**Commit:**
```
feat: Add comprehensive input validation

- Installed Zod for schema validation
- Created validation schemas for all forms
- Added file upload validation
- Added XSS prevention (sanitizeHtml)
- Applied validation to all user inputs

Security improvements:
- âœ“ Email validation
- âœ“ Phone validation (Egyptian numbers)
- âœ“ Password strength requirements
- âœ“ File type/size validation
- âœ“ XSS prevention

Fixes #8 (Input Validation Gaps)
```

Ù†ÙÙ‘Ø° Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.
```

---

## ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù€ Prompts:

1. **Ø§Ø¨Ø¯Ø£ Ø¨Ù€ Prompt #0** (Context Loading)
2. **Ø§Ù†ØªØ¸Ø± Ø±Ø¯ Cursor** Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ§Ù„ÙŠ
3. **ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø®Ø·ÙˆØ©** Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
4. **Ø§Ø®ØªØ¨Ø± ÙƒÙ„ Ø¥ØµÙ„Ø§Ø­** ÙÙˆØ±Ø§Ù‹
5. **Commit Ø¨Ø¹Ø¯ ÙƒÙ„ Ù…Ù‡Ù…Ø©** Ù…ÙƒØªÙ…Ù„Ø©

### Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„:

```
ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ [Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©]:

Ø§Ù„Ø®Ø·Ø£:
[Ù†Øµ Ø§Ù„Ø®Ø·Ø£]

Ù…Ø§ Ø­Ø§ÙˆÙ„Øª:
[ÙˆØµÙ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª]

Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:
[Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª]

Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ:
1. ÙÙ‡Ù… Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£
2. Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­
3. ÙƒÙŠÙ Ø£ØªØ¬Ù†Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
```

### Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø¯Ù…:

```
Ø£Ø±ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†:

1. Ù…Ø§ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙŠ Ø£ÙƒÙ…Ù„Ù†Ø§Ù‡Ø§ØŸ
2. Ù…Ø§ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ
3. Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„ ÙŠØ¬Ø¨ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ØŸ
4. Ù…Ø§ Ù‡Ùˆ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ

Ø£Ø¹Ø·Ù†ÙŠ Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„.
```

---

## ğŸ¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©

Ø§Ù„Ù€ Prompts Ø£Ø¹Ù„Ø§Ù‡ ØªØºØ·ÙŠ **Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø£ÙŠØ§Ù… 1-2)**.

**Ù„Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:**
- Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù†Ù…Ø·
- Ø§Ø±Ø¬Ø¹ Ù„Ù€ `gamasa_daily_execution_plan.md`
- Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…Ø§Ù‹ Ø¨ÙŠÙˆÙ…
- Ø§Ø³ØªØ®Ø¯Ù… `gamasa_unified_analysis.md` ÙƒÙ…Ø±Ø¬Ø¹

---

**Ù…Ù„Ø§Ø­Ø¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©:**
Ù‡Ø°Ù‡ Ø§Ù„Ù€ Prompts Ù…ØµÙ…Ù…Ø© Ù„ØªÙƒÙˆÙ† **ØªØ¯Ø±ÙŠØ¬ÙŠØ© ÙˆÙ…ÙØµÙ„Ø©**. ÙƒÙ„ prompt ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
- âœ… Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„
- âœ… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§Ù‡Ø²
- âœ… Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ°
- âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
- âœ… Commit messages

**Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ù€ Prompt #0!** ğŸš€
